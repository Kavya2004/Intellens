<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ðŸ§± Intellens Project Analyzer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: "Poppins", sans-serif; }
    body { background: radial-gradient(circle at 25% 25%, #f0f3f9, #dfe6ee); min-height: 100vh; }

    /* ---------- START SCREEN ---------- */
    #start-screen {
      height: 100vh; display: grid; place-items: center; text-align: center; padding: 24px;
    }
    .start-card {
      width: min(560px, 92vw);
      background: #fff; border-radius: 20px; padding: 36px 28px;
      box-shadow: 0 16px 40px rgba(0,0,0,.08);
    }
    .start-title { font-size: clamp(28px, 4.5vw, 42px); font-weight: 800; color: #1f2a44; }
    .start-sub { color: #5a6a85; margin: 8px 0 22px; }
    .start-actions { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
    .btn {
      background: #232f3e; color: #fff; border: none; padding: 12px 18px; border-radius: 12px;
      font-weight: 700; cursor: pointer; transition: transform .12s ease, filter .12s ease;
    }
    .btn:hover { transform: translateY(-1px); filter: brightness(1.05); }
    .note { font-size: 12px; color: #7a8aa1; margin-top: 10px; }

    /* ---------- LOADER ---------- */
    #loading {
      display: none; height: 100vh; place-items: center; text-align: center;
    }
    .lego-loader { display: inline-flex; gap: 10px; align-items: end; }
    .stud { width: 18px; height: 18px; border-radius: 6px; animation: hop 1.2s infinite ease-in-out; }
    .stud:nth-child(1){ background:#4ECDC4; animation-delay:.0s }
    .stud:nth-child(2){ background:#FF6B35; animation-delay:.15s }
    .stud:nth-child(3){ background:#FFD166; animation-delay:.30s }
    .stud:nth-child(4){ background:#5ac27c; animation-delay:.45s }
    @keyframes hop { 0%,100%{transform: translateY(0)} 50%{ transform: translateY(-10px)} }

    /* ---------- DASHBOARD LAYOUT ---------- */
    #dashboard { display: none; height: 100vh; position: relative; }
    .sidebar {
      position: absolute; inset: 0 auto 0 0; width: 260px;
      background: linear-gradient(180deg,#232f3e,#39465a); color:#fff;
      box-shadow: 4px 0 12px rgba(0,0,0,.12);
      padding: 26px 16px; overflow: auto;
    }
    .brand { font-weight: 800; letter-spacing: .5px; margin-bottom: 14px; }
    .menu {
      display: grid; gap: 14px;
    }
    .menu-block {
      width: 100%; height: 90px; border-radius: 16px; border: none; cursor: pointer;
      background: #2a3a4f; color:#d0e0d0; font-weight: 800; text-transform: uppercase; letter-spacing: .6px;
      box-shadow: 0 10px 18px rgba(0,0,0,.25), inset 0 -6px 10px rgba(0,0,0,.25), inset 0 6px 10px rgba(255,255,255,.12);
      transition: transform .12s ease, filter .12s ease;
    }
    .menu-block:hover { transform: translateY(-2px); filter: saturate(1.06) brightness(1.04); }
    .menu-block:active { transform: translateY(0); }

    .stage {
      position: absolute; left: 260px; right: 0; top: 0; bottom: 0;
      display: grid; place-items: center; padding: 40px;
      background: repeating-linear-gradient(45deg,#f8fafc 0,#f8fafc 22px,#f1f5f9 22px,#f1f5f9 44px);
    }
    .stage-inner {
      width: min(520px, 70vw); aspect-ratio: 4 / 3; background: #ffffff;
      border-radius: 24px; box-shadow: inset 0 0 22px rgba(0,0,0,.06), 0 18px 36px rgba(0,0,0,.08);
      display: grid; place-items: center; position: relative; overflow: hidden;
    }
    .build-img { max-width: 86%; max-height: 86%; opacity: 0; transform: scale(.92); transition: opacity .35s, transform .35s; }
    .build-img.show { opacity: 1; transform: scale(1); }
    .snap {
      position:absolute; inset:auto 18px 18px auto; background:#232f3e; color:#fff; border:none; border-radius:12px;
      padding:10px 14px; font-weight:700; letter-spacing:.4px; cursor:pointer;
      box-shadow:0 6px 14px rgba(0,0,0,.18);
    }

    /* whoosh finale */
    .whoosh { animation: whoosh .6s ease forwards; }
    @keyframes whoosh {
      0% { transform: scale(.9) rotate(-2deg); filter: blur(0px); }
      60% { transform: scale(1.15) rotate(1deg); filter: blur(2px); }
      100% { transform: scale(1) rotate(0deg); filter: blur(0px); }
    }
    .pulse { animation: pulse 1.2s ease 2; }
    @keyframes pulse { 0%,100%{ transform: scale(1)} 50%{ transform: scale(1.05)} }

    /* ---------- SECTIONS (overlays) ---------- */
    .section {
      position: fixed; inset: 24px 24px 24px 284px; background: #fff; border-radius: 20px;
      box-shadow: 0 0 40px rgba(0,0,0,.26); transform: scale(.94); opacity: 0; pointer-events: none;
      transition: all .28s ease; padding: 26px; overflow: auto; z-index: 5;
    }
    .section.active { transform: scale(1); opacity: 1; pointer-events: auto; }
    .close { position: absolute; top: 14px; right: 18px; font-size: 26px; color: #ff6b35; cursor: pointer; }
    .section h2 { margin-bottom: 10px; }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
    .item { background: #f8f9fa; padding: 10px; border-radius: 6px; }

    .file-item { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 6px; padding: 12px; margin: 8px 0; }
    .file-name { font-weight: 700; color: #495057; margin-bottom: 6px; font-family: monospace; font-size: 13px; }
    .file-tags { display: flex; flex-wrap: wrap; gap: 6px; }
    .tag { padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
    .tag.language { background: #e3f2fd; color: #1976d2; border: 1px solid #bbdefb; }
    .tag.service  { background: #f3e5f5; color: #7b1fa2; border: 1px solid #e1bee7; }
  </style>
</head>
<body>

  <!-- START -->
  <section id="start-screen">
    <div class="start-card">
      <div class="start-title">Start Buildingâ€¦</div>
      <div class="start-sub">Upload a <strong>.zip</strong> of your project and weâ€™ll analyze it into LEGO-style blocks.</div>
      <div class="start-actions">
        <button class="btn" id="startBtn">Choose ZIP</button>
        <input type="file" id="fileInput" accept=".zip" hidden />
      </div>
      <div class="note">Your ZIP is processed locally by your running FastAPI at <code>http://localhost:8000</code>.</div>
    </div>
  </section>

  <!-- LOADING -->
  <section id="loading">
    <div>
      <h2 style="margin-bottom: 10px; color:#1f2a44;">Analyzing your projectâ€¦</h2>
      <div class="lego-loader" style="margin: 14px 0 6px;">
        <div class="stud"></div><div class="stud"></div><div class="stud"></div><div class="stud"></div>
      </div>
      <div class="note">This may take a moment depending on project size.</div>
    </div>
  </section>

  <!-- DASHBOARD -->
  <section id="dashboard">
    <aside class="sidebar">
      <div class="brand">ðŸ§± Dashboard</div>
      <div class="menu">
        <button class="menu-block" data-section="project-summary">Summary</button>
        <button class="menu-block" data-section="system-arch">Architecture</button>
        <button class="menu-block" data-section="terraform">Terraform</button>
        <button class="menu-block" data-section="components">Components</button>
        <button class="menu-block" data-section="frontend">Frontend</button>
        <button class="menu-block" data-section="readme">README</button>
      </div>
    </aside>

    <div class="stage">
      <div class="stage-inner" id="stageBox" title="Click the turtle to open everything">
        <img id="buildImg" class="build-img" alt="build stage" />
        <button class="snap" id="turtleOpenAll" style="display:none;">Open All</button>
      </div>
    </div>
  </section>

  <!-- OVERLAYS -->
  <section id="project-summary" class="section">
    <div class="close" data-close>âœ–</div>
    <h2>Project Summary</h2>
    <div class="grid">
      <div><h3>Languages</h3><div id="languages"></div></div>
      <div><h3>Services & Technologies</h3><div id="services"></div></div>
    </div>
    <div style="margin-top: 16px;">
      <h3>File Details</h3>
      <div id="file-details"></div>
    </div>
  </section>

  <section id="system-arch" class="section">
    <div class="close" data-close>âœ–</div>
    <h2>System Architecture</h2>
    <div id="workflow-diagram"></div>
  </section>

  <section id="terraform" class="section">
    <div class="close" data-close>âœ–</div>
    <h2>Terraform Infrastructure</h2>
    <div id="terraform-diagram"></div>
  </section>

  <section id="components" class="section">
    <div class="close" data-close>âœ–</div>
    <h2>Component Diagram</h2>
    <div id="diagram">
      <div id="nodes"></div>
      <div id="connections"></div>
    </div>
  </section>

  <section id="frontend" class="section">
    <div class="close" data-close>âœ–</div>
    <h2>Frontend Preview</h2>
    <div id="frontend-preview"></div>
  </section>

  <section id="readme" class="section">
    <div class="close" data-close>âœ–</div>
    <h2>Generated README</h2>
    <button class="btn" onclick="copyReadme()">Copy</button>
    <button class="btn" onclick="downloadReadme()">Download</button>
    <pre id="readme-content" style="background:#f8f9fa;border-radius:10px;padding:14px;white-space:pre-wrap;font-family:monospace;font-size:13px;margin-top:12px;"></pre>
  </section>

  <!-- (optional) your existing helpers -->
  <script src="aws-tech-diagram.js"></script>
  <script src="enhanced-aws-tech-diagram.js"></script>
  <script src="aws-infrastructure-designer.js"></script>

  <script>
    // ------ image frames (build progression) ------
    // using your supplied assets; order = from a single block to final turtle
    const BUILD_FRAMES = [
      "images/9-removebg-preview.png",
      "images/8-removebg-preview.png",
      "images/7-removebg-preview.png",
      "images/6-removebg-preview.png",
      "images/5-removebg-preview.png",
      "images/4-removebg-preview.png"
    ];
    const FINAL_TURTLE = "images/Final_Turtle.png"; // last frame doubles as turtle hero
    (() => { const _img = new Image(); _img.src = FINAL_TURTLE; })();

    // ------ state ------
    let analysisData = {};
    let stageIndex = -1;                // which build frame is currently shown
    let clickedSet = new Set();         // which sidebar blocks were clicked
    const orderedSections = [           // the 6 steps that build the turtle
      "project-summary","system-arch","terraform","components","frontend","readme"
    ];

    // preload images for smoother animation
    BUILD_FRAMES.forEach(src => { const i = new Image(); i.src = src; });

    // ------ elements ------
    const startScreen = document.getElementById("start-screen");
    const loading = document.getElementById("loading");
    const dashboard = document.getElementById("dashboard");
    const fileInput = document.getElementById("fileInput");
    const startBtn = document.getElementById("startBtn");
    const buildImg = document.getElementById("buildImg");
    const stageBox = document.getElementById("stageBox");
    const turtleOpenAll = document.getElementById("turtleOpenAll");


    startBtn.addEventListener("click", () => fileInput.click());
    fileInput.addEventListener("change", uploadFile);

    // ------ upload / analyze ------
    async function uploadFile(){
      const file = fileInput.files[0];
      if (!file) return;

      // flip screens
      startScreen.style.display = "none";
      loading.style.display = "grid";

      const formData = new FormData();
      formData.append("file", file);

      try {
        const res = await fetch("http://localhost:8000/upload", { method: "POST", body: formData });
        const data = await res.json();
        analysisData = data;
      } catch (e) {
        alert("Upload failed: " + e.message);
      } finally {
        // go to dashboard either way so UI works even with stub data
        loading.style.display = "none";
        dashboard.style.display = "block";
        initDashboard();
      }
    }

    // ------ dashboard / sidebar clicks -> build + open section ------
    function initDashboard(){
      document.querySelectorAll(".menu-block").forEach(btn => {
        btn.addEventListener("click", () => {
          const section = btn.dataset.section;
          addNextBlock(section);
          openSection(section);
        });
      });

      // clicking the turtle opens all sections at once (nice easter egg)
      turtleOpenAll.addEventListener("click", () => {
        document.querySelectorAll(".section").forEach(s => s.classList.add("active"));
      });

      // also clicking the stage (final) triggers same
      stageBox.addEventListener("click", () => {
        if (stageIndex >= BUILD_FRAMES.length - 1) {
          turtleOpenAll.click();
        }
      });

      // if your backend returned data already, render it into panels
      displayResults(analysisData || {});
    }

    function addNextBlock(section){
      if (clickedSet.has(section)) return; // one block per section
      clickedSet.add(section);

      // only increment if the section is in the ordered list (we ignore extras)
      const pos = orderedSections.indexOf(section);
      if (pos === -1) return;

      // which frame should we be on now? (# of unique clicks capped to frames)
      const targetIndex = Math.min(clickedSet.size - 1, BUILD_FRAMES.length - 1);

      if (targetIndex !== stageIndex){
        stageIndex = targetIndex;
        buildImg.classList.remove("show");
        // small delay lets the CSS transition play
        setTimeout(() => {
          buildImg.src = BUILD_FRAMES[stageIndex];
          buildImg.onload = () => buildImg.classList.add("show");
          // final whoosh once last piece placed
          if (stageIndex === BUILD_FRAMES.length - 1) {
            stageBox.classList.add("whoosh");
            setTimeout(() => { stageBox.classList.remove("whoosh"); stageBox.classList.add("pulse"); }, 620);
            turtleOpenAll.style.display = "inline-block";
          }
        }, 60);
      }
    }

    function openSection(id){
      closeSections();
      document.getElementById(id)?.classList.add("active");

      // render AWS cards gracefully if diagram renderer throws
      if (id === "terraform" && analysisData?.aws_infrastructure_diagram) {
        const target = document.getElementById("terraform-diagram");
        target.innerHTML = "";
        try {
          renderAWSInfrastructureDiagram(target, analysisData.aws_infrastructure_diagram);
        } catch {
          const summary = analysisData.aws_infrastructure_diagram.summary;
          if (summary?.service_types?.length){
            target.innerHTML = `
              <div style="padding: 20px;">
                <h3>AWS Infrastructure Recommendations</h3>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-top:12px;">
                  ${summary.service_types.map(s => `<div style="border:1px solid #e2e8f0;border-radius:10px;padding:12px;background:#fff">${s}</div>`).join("")}
                </div>
              </div>`;
          }
        }
      }
    }

    function closeSections(){
      document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
    }
    // close buttons
    document.querySelectorAll("[data-close]").forEach(x => x.addEventListener("click", closeSections));

    // ------ fill panels with backend results (kept from your original) ------
    function displayResults(data){
      // Languages
      const langs = data.languages || {};
      document.getElementById('languages').innerHTML = Object.entries(langs)
        .map(([lang,count]) => `<div class="item">${lang}: ${count} file(s)</div>`).join('') || '<div class="item">None</div>';

      // Services + (optional) AWS recs
      let allServices = {...(data.services || {})};
      const awsTypes = data?.aws_infrastructure_diagram?.summary?.service_types || [];
      awsTypes.forEach(s => { if (!allServices[s]) allServices[s+" (Recommended)"] = 1; });
      document.getElementById('services').innerHTML = Object.keys(allServices).length
        ? Object.entries(allServices).map(([s,c])=>`<div class="item">${s}: ${c} ref(s)</div>`).join('')
        : '<div class="item">No services detected</div>';

      // File details
      const files = data.file_details || [];
      document.getElementById('file-details').innerHTML = files.map(f => {
        const ltags = (f.languages||[]).map(x=>`<span class="tag language">${x}</span>`).join('');
        const stags = (f.services||[]).map(x=>`<span class="tag service">${x}</span>`).join('');
        return `<div class="file-item"><div class="file-name">${f.file}</div><div class="file-tags">${ltags}${stags}</div></div>`;
      }).join('');

      // Architecture
      if (data.workflow_diagram?.architecture?.components){
        const arch = data.workflow_diagram.architecture;
        const users = arch.components.filter(c=>c.type==='user');
        const apps  = arch.components.filter(c=>c.type==='application');
        const dbs   = arch.components.filter(c=>c.type==='database');
        const comp = c => `
          <div style="padding:14px;border:2px solid #e5e7eb;border-radius:12px;background:#fff;min-width:140px;text-align:center">
            ${c.logo ? `<img src="${c.logo}" alt="${c.title}" style="width:40px;height:40px;object-fit:contain">` : ''}
            <div style="font-weight:700;margin-top:8px">${c.title||''}</div>
            <div style="font-size:12px;color:#64748b">${c.description||''}</div>
          </div>
        `;
        document.getElementById('workflow-diagram').innerHTML = `
          <div style="text-align:center">
            <h4>Actors</h4>
            <div style="display:flex;gap:18px;flex-wrap:wrap;justify-content:center;margin:10px 0 20px">${users.map(comp).join('')}</div>
            <div style="font-size:26px;color:#3b82f6">â†“</div>
            <h4>Application Layer</h4>
            <div style="display:flex;gap:18px;flex-wrap:wrap;justify-content:center;margin:10px 0 20px">${apps.map(comp).join('')}</div>
            ${dbs.length ? `
              <div style="font-size:26px;color:#3b82f6">â†“</div>
              <h4>Data Storage</h4>
              <div style="display:flex;gap:18px;flex-wrap:wrap;justify-content:center;margin:10px 0 20px">${dbs.map(comp).join('')}</div>
            `:``}
          </div>`;
      }

      // Components
      if (data.comprehensive_diagram){
        document.getElementById('nodes').innerHTML =
          '<h4 style="margin:6px 0">Components</h4>' +
          data.comprehensive_diagram.nodes.map(n=>`<div class="item">${n.label} (${n.category})</div>`).join('');
        document.getElementById('connections').innerHTML =
          '<h4 style="margin:6px 0">Connections</h4>' +
          data.comprehensive_diagram.edges.map(e=>`<div class="item">${e.source} â†’ ${e.target}</div>`).join('');
      }

      // Frontend
      document.getElementById('frontend-preview').innerHTML =
        data.frontend_preview || '<div style="text-align:center;padding:40px;color:#666"><h3>No Frontend Detected</h3><p>This looks like a backend/CLI project.</p></div>';

      // README
      document.getElementById('readme-content').textContent = data.readme_content || 'No README content generated';
      window.currentReadmeFilename = data.readme_filename;
    }

    // ------ utilities ------
    function copyReadme(){
      const content = document.getElementById('readme-content').textContent;
      navigator.clipboard.writeText(content).then(()=>alert("README copied!"));
    }
    function downloadReadme(){
      if (!window.currentReadmeFilename) return;
      const a = document.createElement('a');
      a.href = `http://localhost:8000/download-readme/${window.currentReadmeFilename}`;
      a.download = 'README.md';
      a.click();
    }
  </script>
</body>
</html>