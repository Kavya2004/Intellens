<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>üß± Intellens Project Analyzer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --green:#2F7D32;
      --green-500:#2F7D32;
      --green-400:#3F8F43;
      --green-300:#5AA95D;
      --green-200:#A2D4A2;
      --yellow:#E6C229;
      --bg:#EEF5EF;
      --ink:#122012;
      --muted:#5f6b5f;
      --card:#ffffff;
      --ring:#cfe8cf;
    }
    *{box-sizing:border-box}
    html,body{height:100%}

    #bg-logo {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background:
        linear-gradient(to top, #e6f7ed 0%, #f9fffb 50%, #ffffff 100%),
        url("images/logo.png") center center / cover no-repeat;
      z-index: -1;
      opacity: 1;
    }    
    body {
      margin: 0;
      font-family: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--ink);
      overflow: hidden;
      height: 100vh;
      position: relative;
    }    
    
    button{font-family:inherit}

    /* ========== GENERIC ========== */
    .container{max-width:1100px;margin:0 auto;padding:28px 18px}
    .card{
      background:var(--card);
      border:1px solid #e8efe8;
      border-radius:18px;
      box-shadow:0 10px 20px rgba(18,32,18,.04);
    }
    .btn{
      appearance:none;border:none;border-radius:12px;padding:12px 18px;
      background:var(--green-500);color:#fff;font-weight:700;cursor:pointer;
      box-shadow:0 10px 14px rgba(47,125,50,.18);
      transition:transform .12s ease, filter .12s ease, box-shadow .12s ease;
    }
    .btn:hover{transform:translateY(-1px);filter:brightness(1.05);}
    .btn:active{transform:translateY(0)}
    .muted{color:var(--muted)}

    /* ========== SCREEN SWITCH ========== */
    #start-screen,#loader,#dashboard{display:none}
    #start-screen.active,#loader.active,#dashboard.active{display:block}

    /* ========== START SCREEN ========== */
    .start-wrap{display:grid;place-items:center;min-height:100vh}
    .start-card {
      position: relative;
      backdrop-filter: blur(14px);
      border: 2px solid rgba(255,255,255,0.4);
      box-shadow: 0 10px 40px rgba(47, 125, 50, 0.25);
      animation: floatCard 6s ease-in-out infinite;
    }
    
    @keyframes floatCard {
      0%,100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    
    /* soft glowing border around upload zone */
    .dropzone {
      background: rgba(255,255,255,0.6);
      border: 2px dashed rgba(47,125,50,0.4);
      transition: all 0.3s ease;
      box-shadow: inset 0 0 10px rgba(255,255,255,0.4);
    }
    .dropzone:hover {
      border-color: #E6C229;
      box-shadow: 0 0 20px rgba(230,194,41,0.4), inset 0 0 12px rgba(255,255,255,0.5);
    }    
    .start-hero{display:grid;place-items:center;padding-top:14px;}
    .start-icon{
      width:84px;height:84px;border-radius:18px;
      background:var(--green-500);
      color:#fff;display:grid;place-items:center;
      box-shadow:0 16px 30px rgba(47,125,50,.22);
    }
    .start-title{font-size: clamp(28px, 5vw, 48px); text-align:center;font-weight:800;margin:18px 0 6px;}
    .start-sub{ text-align:center; color:var(--muted); margin-bottom:18px }

    /* Drag & Drop */
    .dropzone{
      margin:14px 18px 20px;border:2px dashed var(--ring);border-radius:16px;
      padding:30px;display:grid;place-items:center;gap:8px;
      transition:border-color .15s ease, background .15s ease;
      background:#f4faf4;
    }
    .dropzone.dragover{background:#eef8ee;border-color:var(--green-300)}
    .drop-icon{font-size:34px;opacity:.8}
    .drop-title{font-weight:700}
    .drop-sub{font-size:13px;color:var(--muted)}

    .start-actions{display:flex;gap:12px;justify-content:center;margin:6px 0 8px}
    .learn{display:block;text-align:center;margin:6px 0 22px;color:var(--green-500);font-weight:700;text-decoration:none}

    /* ========== LOADER SCREEN ========== */
/* ========== LOADER SCREEN (Cute Turtle Version) ========== */
.loader-wrap {
  min-height: 100vh;
  display: grid;
  place-items: center;
  background: linear-gradient(180deg, #f0fff0 0%, #e6f7ec 70%, #fafffa 100%);
}
.loader-card {
  width: min(880px, 94vw);
  padding: 28px 28px 22px;
  border-radius: 22px;
  background: #ffffffcc;
  backdrop-filter: blur(8px);
  border: 1px solid #e1eee2;
  box-shadow: 0 18px 40px rgba(0, 0, 0, 0.08);
}

/* Header */
.loader-title {
  text-align: center;
  font-size: clamp(24px, 4.5vw, 36px);
  font-weight: 900;
  margin: 0 0 4px;
}
.loader-sub {
  text-align: center;
  color: var(--muted);
  margin-bottom: 14px;
}

/* === CUTE TURTLE SCENE === */
/* === CUTE TURTLE SCENE (Day ‚Üí Night Transition) === */
.scene {
  position: relative;
  overflow: hidden;
  border: 2px solid #cce6cc;
  border-radius: 20px;
  height: 220px;
  margin: 8px 0 16px;
  background: linear-gradient(180deg, #aee9ff 0%, #e6f7ec 60%, #fff 100%);
  animation: dayToNight 20s ease-in-out infinite alternate;
  box-shadow: inset 0 0 25px rgba(0, 0, 0, 0.08);
}

/* üåû Sun + üåô Moon alternating */
.scene::before {
  content: "‚òÄÔ∏è";
  position: absolute;
  top: 16px;
  right: 24px;
  font-size: 32px;
  animation: sunMoonShift 20s ease-in-out infinite alternate;
  transition: opacity 2s ease;
}

@keyframes dayToNight {
  0% {
    background: linear-gradient(180deg, #aee9ff 0%, #e6f7ec 60%, #fff 100%);
  }
  50% {
    background: linear-gradient(180deg, #5da9e9 0%, #a3d8c0 60%, #eaf8e8 100%);
  }
  100% {
    background: linear-gradient(180deg, #0c1445 0%, #2c3e50 60%, #5a7c70 100%);
  }
}

@keyframes sunMoonShift {
  0% {
    content: "‚òÄÔ∏è";
    transform: translateY(0) rotate(0deg);
    opacity: 1;
  }
  50% {
    opacity: 0;
  }
  100% {
    content: "üåô";
    transform: translateY(-30px);
    opacity: 1;
  }
}

/* üå• Clouds drifting */
.clouds {
  position: absolute;
  inset: 0;
  background:
    radial-gradient(circle at 10% 30%, #fff 20%, transparent 60%) 0 0/240px 80px,
    radial-gradient(circle at 60% 40%, #fff 25%, transparent 60%) 200px 40px/280px 90px;
  animation: cloudsDrift 40s linear infinite;
  opacity: 0.8;
}

@keyframes cloudsDrift {
  to {
    background-position: -400px 0, -300px 0;
  }
}

/* üåü Stars appear at night */
.star {
  position: absolute;
  background: radial-gradient(circle, #fff 0%, rgba(255, 255, 255, 0) 60%);
  width: 5px;
  height: 5px;
  border-radius: 50%;
  opacity: 0;
  animation: starTwinkle 20s ease-in-out infinite alternate;
}

.star:nth-child(1) { top: 20px; left: 40px; animation-delay: 3s; }
.star:nth-child(2) { top: 60px; left: 160px; animation-delay: 7s; }
.star:nth-child(3) { top: 40px; right: 120px; animation-delay: 11s; }
.star:nth-child(4) { top: 90px; right: 40px; animation-delay: 5s; }

@keyframes starTwinkle {
  0%, 40% {
    opacity: 0;
  }
  50%, 100% {
    opacity: 1;
  }
}

/* üåø Ground + Track */
.ground {
  position: absolute;
  bottom: 0;
  width: 100%;
  height: 70px;
  background: linear-gradient(0deg, #66b969 0%, #7ed57e 50%, #b4ebb2 100%);
  border-top: 2px solid #a5e5a5;
}

.track {
  position: absolute;
  bottom: 30px;
  left: 0;
  right: 0;
  height: 8px;
  background: repeating-linear-gradient(90deg, #2f7d32 0 60px, transparent 60px 100px);
  animation: trackSlide 1.4s linear infinite;
  opacity: 0.85;
}

@keyframes trackSlide {
  to {
    background-position-x: -100px;
  }
}

/* ‚ú® sparkles */
@keyframes sparkle {
  0%,
  100% {
    opacity: 0.6;
    transform: scale(1);
  }
  50% {
    opacity: 1;
    transform: scale(1.3);
  }
}
.sparkle {
  position: absolute;
  width: 8px;
  height: 8px;
  background: radial-gradient(circle, #fff 0%, rgba(255, 255, 255, 0) 70%);
  border-radius: 50%;
  animation: sparkle 3s ease-in-out infinite;
}
.sparkle:nth-child(1) {
  top: 20px;
  left: 40px;
  animation-delay: 0s;
}
.sparkle:nth-child(2) {
  top: 50px;
  left: 150px;
  animation-delay: 1s;
}
.sparkle:nth-child(3) {
  top: 30px;
  right: 100px;
  animation-delay: 2s;
}
.sparkle:nth-child(4) {
  top: 80px;
  right: 40px;
  animation-delay: 2.5s;
}

/* üê¢ Turtle */
.turtle {
  --size: 90px;
  position: absolute;
  bottom: 42px;
  left: -100px;
  width: var(--size);
  height: var(--size);
  animation: turtleRun 4.5s cubic-bezier(.19, 1, .22, 1) infinite;
  filter: drop-shadow(0 10px 14px rgba(0, 0, 0, 0.2));
}
.turtle .shell {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  background: radial-gradient(circle at 40% 40%, #4e9a51 0%, #2f7d32 80%);
  border: 4px solid #215821;
  position: relative;
  overflow: hidden;
  transform-origin: 50% 70%;
  animation: shellBob 1s ease-in-out infinite;
}
.turtle .shell::before {
  content: "";
  position: absolute;
  inset: 12px;
  border-radius: 50%;
  border: 3px dashed rgba(255, 255, 255, 0.4);
}
.turtle .head {
  position: absolute;
  right: -16px;
  top: 35%;
  width: 30px;
  height: 24px;
  border-radius: 40px;
  background: #78c978;
  border: 3px solid #215821;
  transform-origin: left center;
  animation: headBob 1s ease-in-out infinite;
}
.turtle .eye {
  position: absolute;
  right: 6px;
  top: 6px;
  width: 6px;
  height: 6px;
  background: #122012;
  border-radius: 50%;
}
.turtle .smile {
  position: absolute;
  right: 4px;
  bottom: 6px;
  width: 10px;
  height: 2px;
  border-bottom: 2px solid #122012;
  border-radius: 50%;
}
.turtle .leg {
  position: absolute;
  width: 18px;
  height: 10px;
  background: #78c978;
  border: 2px solid #215821;
  border-radius: 10px;
  bottom: -6px;
  animation: legMove 0.4s ease-in-out infinite;
}
.turtle .leg.l1 {
  left: 8px;
  animation-delay: 0s;
}
.turtle .leg.r1 {
  left: 42px;
  animation-delay: 0.2s;
}
.turtle .leg.l2 {
  left: 22px;
  animation-delay: 0.1s;
}
.turtle .leg.r2 {
  left: 54px;
  animation-delay: 0.3s;
}
.turtle .tail {
  position: absolute;
  left: -8px;
  bottom: 24px;
  width: 10px;
  height: 6px;
  border-radius: 50%;
  background: #66b969;
  border: 2px solid #215821;
  transform-origin: right center;
  animation: tailWag 0.6s ease-in-out infinite;
}
@keyframes turtleRun {
  0% {
    left: -110px;
  }
  60% {
    left: calc(100% - 110px);
  }
  100% {
    left: calc(100% + 40px);
  }
}
@keyframes shellBob {
  0%,
  100% {
    transform: translateY(0) rotate(-1deg);
  }
  50% {
    transform: translateY(-3px) rotate(2deg);
  }
}
@keyframes headBob {
  0%,
  100% {
    transform: rotate(0deg);
  }
  50% {
    transform: rotate(4deg);
  }
}
@keyframes legMove {
  0%,
  100% {
    transform: translateY(0);
  }
  50% {
    transform: translateY(2px);
  }
}
@keyframes tailWag {
  0%,
  100% {
    transform: rotate(0deg);
  }
  50% {
    transform: rotate(12deg);
  }
}

/* Progress bar + Steps (same as before) */
.progress {
  height: 10px;
  background: #e9f3ea;
  border: 1px solid #d9e7da;
  border-radius: 999px;
  overflow: hidden;
  margin: 0 2px 6px;
}
.progress > .bar {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, #3f8f43, #5aa95d);
  box-shadow: 0 0 12px rgba(47, 125, 50, 0.35) inset;
  transition: width 0.6s ease;
}
.loader-steps {
  display: grid;
  gap: 10px;
  margin-top: 10px;
}
.step {
  display: flex;
  align-items: center;
  gap: 10px;
  background: #fff;
  border: 1px solid #e6eee6;
  padding: 12px;
  border-radius: 12px;
  transition: all 0.2s ease;
}
.step .dot-mini {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #9fbf9f;
}
.step.active {
  border-color: #cfe8cf;
  background: #f5fbf6;
  transform: translateX(4px);
}
.step.active .dot-mini {
  background: #2f7d32;
}

    /* ========== DASHBOARD ========== */

#dashboard {
  height: 100vh;
  background: radial-gradient(circle at 25% 25%, #f4f9f4 0%, #eaf3ea 100%);
  display: flex;
  align-items: center;
  justify-content: center;
}

.dash-layout {
  display: grid;
  grid-template-columns: 310px 1fr;
  height: 90vh;
  width: 94vw;
  border-radius: 28px;
  background: #ffffffc7;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
  overflow: hidden;
  backdrop-filter: blur(8px);
}

/* Sidebar */
.sidebar {
  background: linear-gradient(180deg, #f5faf5 0%, #e6f3e7 100%);
  padding: 24px 18px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  border-right: 1px solid #d9e6d9;
  box-shadow: inset -2px 0 8px rgba(0, 0, 0, 0.03);
}

.sidebar-title {
  font-weight: 900;
  font-size: 1.6rem;
  color: var(--green-500);
  margin-bottom: 18px;
  text-shadow: 0 1px 0 #ffffff;
}

.sidebar-sub {
  display: none;
}

/* LEGO Buttons */
.lego-menu {
  display: grid;
  grid-template-rows: repeat(6, 1fr);
  gap: 14px;
  justify-items: center;
  width: 100%;
}

.lego-button {
  background: transparent;
  border: none;
  text-align: center;
  cursor: pointer;
  width: 100%;
  transition: all 0.2s ease;
  padding: 4px;
  border-radius: 10px;
}
.lego-button:hover {
  background: #f0f8f0;
  transform: scale(1.03);
  box-shadow: 0 4px 10px rgba(47, 125, 50, 0.08);
}

.lego-img {
  width: 125px;
  height: auto;
  display: block;
  margin: 0 auto;
  filter: drop-shadow(0 5px 10px rgba(0, 0, 0, 0.1));
  transition: transform 0.15s ease, filter 0.15s ease;
  pointer-events: none;
}

.lego-button:hover .lego-img {
  transform: translateY(-3px) scale(1.07);
  filter: drop-shadow(0 10px 15px rgba(0, 0, 0, 0.2));
}

.lego-title {
  font-weight: 800;
  margin-top: 6px;
  font-size: 15px;
}

.lego-sub {
  color: var(--muted);
  font-size: 12px;
  margin-top: 2px;
}

/* Stage Area */
.stage {
  background: #f8fcf8;
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%;
}

.stage-inner {
  width: min(600px, 70vw);
  aspect-ratio: 1 / 1;
  background: linear-gradient(180deg, #ffffff 0%, #f4faf4 100%);
  border-radius: 26px;
  border: 1px solid #dce6dc;
  box-shadow: 0 16px 40px rgba(0, 0, 0, 0.06),
              inset 0 0 12px rgba(255, 255, 255, 0.4);
  display: grid;
  place-items: center;
  position: relative;
  overflow: hidden;
  animation: breathe 6s ease-in-out infinite;
}

@keyframes breathe {
  0%, 100% { transform: scale(1); box-shadow: 0 16px 40px rgba(0, 0, 0, 0.06); }
  50% { transform: scale(1.015); box-shadow: 0 20px 50px rgba(0, 0, 0, 0.08); }
}

.build-img {
  max-width: 88%;
  max-height: 88%;
  opacity: 0;
  transform: scale(0.94);
  transition: opacity 0.4s, transform 0.4s;
}
.build-img.show {
  opacity: 1;
  transform: scale(1);
}

.snap {
  position: absolute;
  bottom: 18px;
  right: 18px;
  background: var(--green-500);
  color: #fff;
  border: none;
  border-radius: 12px;
  padding: 10px 16px;
  font-weight: 700;
  letter-spacing: 0.4px;
  cursor: pointer;
  box-shadow: 0 6px 14px rgba(0, 0, 0, 0.18);
  display: none;
  transition: transform 0.2s ease, background 0.2s ease;
}
.snap:hover {
  transform: scale(1.05);
  background: var(--green-400);
}

    .stage{background:#F1F6F1;display:grid;place-items:center;padding:34px}
    .stage-inner{
      width:min(680px,78vw);aspect-ratio:4/3;background:#ffffff;border:1px solid #e6eee6;border-radius:22px;
      box-shadow:inset 0 0 22px rgba(0,0,0,.05),0 18px 36px rgba(0,0,0,.06);
      display:grid;place-items:center;position:relative;overflow:hidden;
    }
    .stage-empty{text-align:center;padding:20px}
    .stage-empty h2{margin:8px 0 0;font-size:clamp(22px,4vw,30px)}
    .stage-empty p{color:var(--muted);margin:4px 0 0}
    .build-img{max-width:86%;max-height:86%;opacity:0;transform:scale(.92);transition:opacity .35s, transform .35s}
    .build-img.show{opacity:1;transform:scale(1)}
    .snap{position:absolute;inset:auto 18px 18px auto;background:var(--green-500);color:#fff;border:none;border-radius:12px;
      padding:10px 14px;font-weight:700;letter-spacing:.4px;cursor:pointer;box-shadow:0 6px 14px rgba(0,0,0,.18);display:none}
    .whoosh{animation:whoosh .6s ease forwards}
    @keyframes whoosh{0%{transform:scale(.9) rotate(-2deg)}60%{transform:scale(1.15) rotate(1deg)}100%{transform:scale(1) rotate(0)}}
    .pulse{animation:pulse 1.2s ease 2}@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}

    /* OVERLAYS */
    .section{position:fixed;inset:24px 24px 24px 304px;background:#fff;border-radius:20px;
      box-shadow:0 20px 50px rgba(0,0,0,.14);transform:scale(.94);opacity:0;pointer-events:none;
      transition:all .28s ease;padding:26px;overflow:auto;z-index:5}
    .section.active{transform:scale(1);opacity:1;pointer-events:auto}
    .close{position:absolute;top:14px;right:18px;font-size:26px;color:#D84315;cursor:pointer}
    .section h2{margin-bottom:14px;font-size:clamp(24px,4vw,32px)}
    .section h3{margin-top:16px;margin-bottom:8px;color:#2F7D32}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .item{background:#f8f9fa;padding:12px;border-radius:8px;border:1px solid #e9ecef;transition:all .2s ease}
    .item:hover{border-color:#cfe8cf;background:#f4faf4}
    .file-item{background:#f8f9fa;border:1px solid #e9ecef;border-radius:8px;padding:12px;margin:8px 0;transition:all .2s ease}
    .file-item:hover{border-color:#cfe8cf;background:#f4faf4}
    .file-name{font-weight:700;color:#495057;margin-bottom:6px;font-family:monospace;font-size:13px}
    .file-tags{display:flex;flex-wrap:wrap;gap:6px}
    .tag{padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600}
    .tag.language{background:#e3f2fd;color:#1976d2;border:1px solid #bbdefb}
    .tag.service{background:#f3e5f5;color:#7b1fa2;border:1px solid #e1bee7}

    @media (max-width:860px){
      .dash-layout{grid-template-columns:1fr}
      .section{inset:14px}
    }
    /* ========== SERVICE POPUP ========== */
    .service-popup-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.3);backdrop-filter:blur(2px);display:none;z-index:25}
    .service-popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:min(600px,90vw);max-height:70vh;background:#fff;border-radius:16px;box-shadow:0 20px 40px rgba(0,0,0,.2);display:none;z-index:26;overflow:hidden}
    .service-popup-header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;background:var(--green-500);color:#fff}
    .service-popup-header h3{margin:0;font-size:18px}
    .service-popup-close{cursor:pointer;font-size:20px;opacity:.9}
    .service-popup-close:hover{opacity:1}
    .service-popup-body{padding:16px 20px;max-height:50vh;overflow-y:auto}
    .reference-item{margin-bottom:12px;padding:12px;background:#f8f9fa;border-radius:8px;border-left:4px solid var(--green-500)}
    .reference-file{font-weight:700;color:var(--green-500);margin-bottom:4px;font-size:14px}
    .reference-line{font-size:12px;color:#666;margin-bottom:6px}
    .reference-code{font-family:monospace;background:#fff;padding:8px;border-radius:4px;border:1px solid #e9ecef;font-size:13px;white-space:pre-wrap;overflow-x:auto}
    .reference-match{background:#fff3cd;padding:2px 4px;border-radius:3px}

    /* ========== INSIGHTS MODAL (new, non-breaking) ========== */
    .insights-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.22);backdrop-filter:blur(2px);display:none;z-index:30}
    .insights-backdrop.show{display:block}
    .insights{position:fixed;inset:24px;background:#fff;border-radius:24px;box-shadow:0 30px 80px rgba(0,0,0,.24);overflow:hidden;display:none;z-index:31}
    .insights.show{display:grid;grid-template-rows:auto 56px 1fr}
    .insights-header{display:flex;align-items:center;gap:14px;background:linear-gradient(180deg,#2F7D32,#2c6f2f);color:#fff;padding:16px 22px}
    .insights-icon{width:44px;height:44px;border-radius:12px;background:rgba(255,255,255,.12);display:grid;place-items:center}
    .insights-title{font-weight:900;font-size:clamp(20px,3.6vw,28px)}
    .insights-sub{opacity:.9;font-size:14px}
    .tabs{display:flex;gap:8px;align-items:center;background:#eaf4eb;padding:8px 12px}
    .tab{appearance:none;border:none;background:transparent;padding:10px 14px;border-radius:12px;font-weight:700;color:#2b5530;cursor:pointer}
    .tab[aria-selected="true"]{background:#ffffff;box-shadow:0 2px 6px rgba(0,0,0,.06);color:#1f3f23}
    .insights-body{padding:18px 18px 24px;overflow:auto}
    .section-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .kpi{grid-column:span 3;background:#f6fbf6;border:1px solid #e0eee0;border-radius:16px;padding:16px}
    .kpi h4{margin:0 0 6px;font-size:13px;color:#557a59;font-weight:700}
    .kpi strong{font-size:22px}
    .panel{grid-column:1/-1;background:#f1f7f2;border:1px solid #e0eee0;border-radius:16px;padding:16px}
    .bullets{display:grid;gap:10px;margin-top:8px}
    .bubble{display:inline-block;background:#fff;border:1px solid #e5ece6;border-radius:12px;padding:6px 10px;margin:4px 6px 0 0;font-size:12px}
    .muter{color:#5f6b5f}
    .x-close{position:absolute;right:18px;top:12px;cursor:pointer;font-size:28px;color:#fff;opacity:.9}
    .hide{display:none}
    /* === HOME BUTTON STYLE === */
  #homeBtn {
    margin-bottom: 18px;
    width: 90%;
    background: #E6C229;
    color: #122012;
    font-weight: 800;
    border: none;
    border-radius: 12px;
    padding: 12px 18px;
    cursor: pointer;
    transition: transform 0.15s ease, filter 0.15s ease;
  }

  #homeBtn:hover {
    filter: brightness(1.1);
    transform: scale(1.03);
  }
  </style>
</head>
  <!-- ============== START ============== -->
  <div class="lego-bubbles">
    <div class="bubble" style="--x:10%;--d:15s;--s:1.1;--c:#2F7D32;"></div>
    <div class="bubble" style="--x:30%;--d:18s;--s:0.9;--c:#E6C229;"></div>
    <div class="bubble" style="--x:60%;--d:20s;--s:1.3;--c:#5AA95D;"></div>
    <div class="bubble" style="--x:80%;--d:25s;--s:1;--c:#A2D4A2;"></div>
  </div>
  <section id="start-screen" class="active">
    <div class="start-wrap">
      <div class="start-card card">
        <div class="start-hero">
          <div class="start-icon">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <rect x="3" y="3" width="7" height="7" rx="1"></rect>
              <rect x="14" y="3" width="7" height="7" rx="1"></rect>
              <rect x="3" y="14" width="7" height="7" rx="1"></rect>
              <rect x="14" y="14" width="7" height="7" rx="1"></rect>
            </svg>
          </div>
        </div>
        <h1 class="start-title">Intellens</h1>
        <p class="start-sub">Upload your project ZIP file to analyze architecture, Terraform, and more.</p>

        <div id="dropzone" class="dropzone">
          <div class="drop-icon">‚¨ÜÔ∏è</div>
          <div class="drop-title">Drag & drop your ZIP file here</div>
          <div class="drop-sub">or click to browse</div>
          <input type="file" id="fileInput" accept=".zip" hidden />
        </div>

        <div class="start-actions">
          <button class="btn" id="chooseBtn">Choose File</button>
        </div>
        <a class="learn" href="#" onclick="alert('This is a local prototype that sends your ZIP to http://localhost:8000/upload');return false;">Learn more about this project ‚Üí</a>
      </div>
      <p class="muted" style="text-align:center;margin-top:12px">Processed locally by your FastAPI at <code>http://localhost:8000</code>.</p>
    </div>
  </section>

  <!-- ============== LOADER ============== -->
  <section id="loader">
    <div class="loader-wrap">
      <div class="loader-card card">
        <div class="loader-title">Analyzing your project‚Ä¶</div>
        <div class="loader-sub">Building your LEGO structure</div>
  
        <div class="scene" aria-hidden="true">
          <div class="clouds"></div>
          <div class="sparkle"></div>
          <div class="sparkle"></div>
          <div class="sparkle"></div>
          <div class="sparkle"></div>
          <div class="ground"></div>
          <div class="track"></div>
        
          <div class="turtle">
            <div class="shell"></div>
            <div class="head">
              <div class="eye"></div>
              <div class="smile"></div>
            </div>
            <div class="leg l1"></div>
            <div class="leg r1"></div>
            <div class="leg l2"></div>
            <div class="leg r2"></div>
            <div class="tail"></div>
          </div>
        </div>        
  
        <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100">
          <div class="bar" id="loaderBar"></div>
        </div>
  
        <div class="loader-steps" id="loaderSteps">
          <div class="step"><span class="dot-mini"></span> Extracting files</div>
          <div class="step"><span class="dot-mini"></span> Analyzing architecture</div>
          <div class="step"><span class="dot-mini"></span> Processing Infrastructure</div>
          <div class="step"><span class="dot-mini"></span> Generating insights</div>
        </div>
      </div>
    </div>
  </section>  

  <!-- ============== DASHBOARD ============== -->
  <section id="dashboard">
    <div class="dash-layout">
      <aside class="sidebar">
        <button class="btn" id="homeBtn" style="margin-bottom:18px;width:90%;background:#E6C229;color:#122012;font-weight:800;">
          ‚¨Ö Home
        </button>        
        <div class="sidebar-title">Select Blocks</div>
        <div class="sidebar-sub">Click a LEGO block to add it to the build.</div>
        <div class="lego-menu">
          <button class="lego-button menu-block" data-section="project-summary" aria-label="Open Summary">
            <img class="lego-img" src="images/2-removebg-preview.png" alt="LEGO brick for Summary">
            <div class="lego-title">Summary</div>
          </button>

          <button class="lego-button menu-block" data-section="system-arch" aria-label="Open Architecture">
            <img class="lego-img" src="images/1-removebg-preview.png" alt="LEGO brick for Architecture">
            <div class="lego-title">Architecture</div>
          </button>

          <button class="lego-button menu-block" data-section="terraform" aria-label="Open Infrastructure">
            <img class="lego-img" src="images/3-removebg-preview.png" alt="LEGO brick for Infrastructure">
            <div class="lego-title">Infrastructure</div>
          </button>

          <button class="lego-button menu-block" data-section="components" aria-label="Open Components">
            <img class="lego-img" src="images/1-removebg-preview.png" alt="LEGO brick for Components">
            <div class="lego-title">Components</div>
          </button>

          <button class="lego-button menu-block" data-section="frontend" aria-label="Open Frontend">
            <img class="lego-img" src="images/2-removebg-preview.png" alt="LEGO brick for Frontend">
            <div class="lego-title">Frontend</div>
          </button>

          <button class="lego-button menu-block" data-section="readme" aria-label="Open README">
            <img class="lego-img" src="images/3-removebg-preview.png" alt="LEGO brick for README">
            <div class="lego-title">README</div>
          </button>
        </div>
      </aside>

      <div class="stage">
        <div class="stage-inner" id="stageBox" title="Click to open all sections">
          <div class="stage-empty" id="stageEmpty">
            <div style="font-size:40px">üß±</div>
            <h2>Start Building!</h2>
            <p>Click on the LEGO blocks in the sidebar to add them to your structure. Collect all blocks to complete the build!</p>
          </div>
          <img id="buildImg" class="build-img" alt="build stage" />
          <button class="snap" id="turtleOpenAll">Open All</button>
        </div>
      </div>
    </div>
  </section>

  <!-- ============== SERVICE REFERENCES POPUP ============= -->
  <div id="servicePopupBackdrop" class="service-popup-backdrop"></div>
  <div id="servicePopup" class="service-popup">
    <div class="service-popup-header">
      <h3 id="servicePopupTitle">Service References</h3>
      <span id="servicePopupClose" class="service-popup-close">‚úñ</span>
    </div>
    <div class="service-popup-body" id="servicePopupBody">
      <!-- References will be populated here -->
    </div>
  </div>

  <!-- ============== OVERLAYS ============== -->
  <section id="project-summary" class="section">
    <div class="close" data-close>‚úñ</div>
    <h2>Project Summary</h2>
    
    <!-- Project Overview -->
    <div id="project-overview" style="margin-bottom: 24px; padding: 16px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #2F7D32;">
      <h3 style="margin-top: 0; color: #2F7D32;">üìã Project Overview</h3>
      <div id="overview-content" style="line-height: 1.6; color: #495057;"></div>
    </div>
    
    <div class="grid">
      <div><h3>Languages</h3><div id="languages"></div></div>
      <div><h3>Services & Technologies</h3><div id="services"></div></div>
    </div>
    <div style="margin-top: 16px;">
      <h3>File Details</h3>
      <div id="file-details"></div>
    </div>
  </section>

  <section id="system-arch" class="section">
    <div class="close" data-close>‚úñ</div>
    <h2>System Architecture</h2>
    <div id="workflow-diagram"></div>
  </section>

  <section id="terraform" class="section">
    <div class="close" data-close>‚úñ</div>
    <h2>Infrastructure</h2>
    <div id="terraform-diagram"></div>
  </section>

  <section id="components" class="section">
    <div class="close" data-close>‚úñ</div>
    <h2>Component Diagram</h2>
    <div id="diagram">
      <div id="nodes"></div>
      <div id="connections"></div>
    </div>
  </section>

  <section id="frontend" class="section">
    <div class="close" data-close>‚úñ</div>
    <h2>Frontend Preview</h2>
    <div id="frontend-preview"></div>
  </section>

  <section id="readme" class="section">
    <div class="close" data-close>‚úñ</div>
    <h2>Generated README</h2>
    <div style="display:flex;gap:12px;margin-bottom:16px">
      <button class="btn" onclick="copyReadme()">Copy</button>
      <button class="btn" onclick="toggleReadmePreview()">Preview</button>
      <button class="btn" onclick="downloadReadme()">Download</button>
    </div>
    <pre id="readme-content" style="background:#f8f9fa;border-radius:10px;padding:14px;white-space:pre-wrap;font-family:monospace;font-size:13px;margin-top:12px;"></pre>
  </section>

  <!-- ============== COMPLETE PROJECT INSIGHTS (new) ============= -->
  <div id="insightsBackdrop" class="insights-backdrop"></div>
  <div id="insightsModal" class="insights" role="dialog" aria-modal="true" aria-labelledby="insightsTitle">
    <div class="insights-header">
      <div class="insights-icon">üß©</div>
      <div>
        <div id="insightsTitle" class="insights-title">Complete Project Insights</div>
        <div class="insights-sub">Explore all aspects of your project analysis</div>
      </div>
      <div id="insightsClose" class="x-close" title="Close">‚úñ</div>
    </div>

    <div class="tabs" role="tablist">
      <button class="tab" role="tab" id="tab-overview" aria-controls="panel-overview" aria-selected="true">Overview</button>
      <button class="tab" role="tab" id="tab-arch" aria-controls="panel-arch">Architecture</button>
      <button class="tab" role="tab" id="tab-infra" aria-controls="panel-infra">Infrastructure</button>
      <button class="tab" role="tab" id="tab-components" aria-controls="panel-components">Components</button>
      <button class="tab" role="tab" id="tab-frontend" aria-controls="panel-frontend">Frontend</button>
      <button class="tab" role="tab" id="tab-docs" aria-controls="panel-docs">Documentation</button>
    </div>

    <div class="insights-body">
      <!-- Overview -->
      <div id="panel-overview" role="tabpanel" class="section-grid">
        <div class="kpi"><h4>Total Files</h4><strong id="kpi-files">‚Äî</strong></div>
        <div class="kpi"><h4>Languages</h4><strong id="kpi-langs">‚Äî</strong></div>
        <div class="kpi"><h4>Framework</h4><strong id="kpi-framework">‚Äî</strong></div>
        <div class="kpi"><h4>Build Tool</h4><strong id="kpi-build">‚Äî</strong></div>

        <div class="panel">
          <h3 style="margin:0 0 8px">Key Highlights</h3>
          <div id="overview-bullets" class="bullets"></div>
        </div>
      </div>

      <!-- Architecture -->
      <div id="panel-arch" role="tabpanel" class="section-grid hide">
        <div class="kpi"><h4>Pattern</h4><strong id="kpi-pattern">Component-based</strong></div>
        <div class="kpi"><h4>Routing</h4><strong id="kpi-routing">‚Äî</strong></div>
        <div class="kpi"><h4>State</h4><strong id="kpi-state">‚Äî</strong></div>
        <div class="kpi"><h4>Styling</h4><strong id="kpi-styling">‚Äî</strong></div>

        <div class="panel" id="arch-cards"></div>
      </div>

      <!-- Infrastructure -->
      <div id="panel-infra" role="tabpanel" class="section-grid hide">
        <div class="kpi"><h4>Provider</h4><strong id="kpi-provider">‚Äî</strong></div>
        <div class="kpi"><h4>Version</h4><strong id="kpi-version">‚Äî</strong></div>
        <div class="kpi"><h4>Modules</h4><strong id="kpi-modules">‚Äî</strong></div>
        <div class="kpi"><h4>Resources</h4><strong id="kpi-resources">‚Äî</strong></div>

        <div class="panel">
          <h3 style="margin:0 0 8px">Key Highlights</h3>
          <div id="infra-bullets" class="bullets"></div>
        </div>
      </div>

      <!-- Components -->
      <div id="panel-components" role="tabpanel" class="section-grid hide">
        <div class="kpi"><h4>UI Components</h4><strong id="kpi-ui">‚Äî</strong></div>
        <div class="kpi"><h4>Custom Components</h4><strong id="kpi-custom">‚Äî</strong></div>
        <div class="kpi"><h4>Pages</h4><strong id="kpi-pages">‚Äî</strong></div>
        <div class="kpi"><h4>Hooks</h4><strong id="kpi-hooks">‚Äî</strong></div>

        <div class="panel">
          <h3 style="margin:0 0 8px">Key Highlights</h3>
          <div id="components-bullets" class="bullets"></div>
        </div>
      </div>

      <!-- Frontend -->
      <div id="panel-frontend" role="tabpanel" class="section-grid hide">
        <div class="kpi"><h4>Framework</h4><strong id="kpi-fe-fw">‚Äî</strong></div>
        <div class="kpi"><h4>TypeScript</h4><strong id="kpi-ts">‚Äî</strong></div>
        <div class="kpi"><h4>Build Time</h4><strong id="kpi-buildtime">‚Äî</strong></div>
        <div class="kpi"><h4>Bundle Size</h4><strong id="kpi-bundle">‚Äî</strong></div>

        <div class="panel">
          <h3 style="margin:0 0 8px">Key Highlights</h3>
          <div id="frontend-bullets" class="bullets"></div>
        </div>
      </div>

      <!-- Documentation -->
      <div id="panel-docs" role="tabpanel" class="section-grid hide">
        <div class="kpi"><h4>Setup Time</h4><strong id="kpi-setup">‚Äî</strong></div>
        <div class="kpi"><h4>Prerequisites</h4><strong id="kpi-prereq">‚Äî</strong></div>
        <div class="kpi"><h4>Scripts</h4><strong id="kpi-scripts">‚Äî</strong></div>
        <div class="kpi"><h4>Documentation</h4><strong id="kpi-docs">‚Äî</strong></div>

        <div class="panel">
          <h3 style="margin:0 0 8px">README</h3>
          <div class="muter" style="margin-bottom:8px">Open the ‚ÄúGenerated README‚Äù overlay to copy or download.</div>
          <pre id="docs-readme" class="card" style="padding:12px;white-space:pre-wrap;font-family:monospace;font-size:12px;max-height:280px;overflow:auto;"></pre>
        </div>
      </div>
    </div>
  </div>

  <script src="aws-tech-diagram.js"></script>
  <script src="enhanced-aws-tech-diagram.js"></script>
  <script src="aws-infrastructure-designer.js"></script>
  <script src="layered-file-renderer.js"></script>

  <script>
    const BUILD_FRAMES = [
      "images/9-removebg-preview.png",
      "images/8-removebg-preview.png",
      "images/7-removebg-preview.png",
      "images/6-removebg-preview.png",
      "images/5-removebg-preview.png",
      "images/4-removebg-preview.png"
    ];
    const FINAL_TURTLE = "images/Final_Turtle.png";
    (() => { const _img = new Image(); _img.src = FINAL_TURTLE; })(); 

    const BACKGROUND_LOGO = "images/logo.png";
    (() => { const preload = new Image(); preload.src = BACKGROUND_LOGO; })();

    document.addEventListener("DOMContentLoaded", () => {
      Object.assign(document.body.style, {
        background: `linear-gradient(to top, #e6f7ed 0%, #f9fffb 50%, #ffffff 100%), url('${BACKGROUND_LOGO}') center center / cover no-repeat`,
        backgroundSize: "cover",
        backgroundRepeat: "no-repeat",
        backgroundAttachment: "fixed",
        backgroundPosition: "center",
      });
    });

    let analysisData = {};
    let stageIndex = -1;
    let clickedSet = new Set();
    const orderedSections = ["project-summary","system-arch","terraform","components","frontend","readme"];
    BUILD_FRAMES.forEach(src=>{const i=new Image(); i.src=src;});

    const startScreen = document.getElementById("start-screen");
    const loader = document.getElementById("loader");
    const dashboard = document.getElementById("dashboard");
    const dropzone = document.getElementById("dropzone");
    const fileInput = document.getElementById("fileInput");
    const chooseBtn = document.getElementById("chooseBtn");
    const buildImg = document.getElementById("buildImg");
    const stageBox = document.getElementById("stageBox");
    const stageEmpty = document.getElementById("stageEmpty");
    const turtleOpenAll = document.getElementById("turtleOpenAll");
    const insightsBackdrop = document.getElementById('insightsBackdrop');
    const insightsModal = document.getElementById('insightsModal');
    const insightsClose = document.getElementById('insightsClose');
    const tabButtons = [
      'overview','arch','infra','components','frontend','docs'
    ].map(id => document.getElementById(`tab-${id}`));
    const tabPanels = [
      'panel-overview','panel-arch','panel-infra','panel-components','panel-frontend','panel-docs'
    ].map(id => document.getElementById(id));

    chooseBtn.addEventListener("click", () => fileInput.click());
    dropzone.addEventListener("click", () => fileInput.click());
    dropzone.addEventListener("dragover", (e)=>{e.preventDefault(); dropzone.classList.add("dragover")});
    dropzone.addEventListener("dragleave", ()=>dropzone.classList.remove("dragover"));
    dropzone.addEventListener("drop", (e)=>{
      e.preventDefault(); dropzone.classList.remove("dragover");
      const file = e.dataTransfer.files?.[0]; if(file){ handleUpload(file); }
    });
    fileInput.addEventListener("change", () => {
      const f = fileInput.files[0]; if(!f) return; handleUpload(f);
    });

        // ===== Loader UX helpers =====
    let loaderInterval = null;
    let loaderTick = 0;

    function startLoaderUI() {
      const steps = Array.from(document.querySelectorAll('#loaderSteps .step'));
      const bar = document.getElementById('loaderBar');
      loaderTick = 0;

      steps.forEach(s => s.classList.remove('active'));
      bar.style.width = '0%';

      loaderInterval = setInterval(() => {
        loaderTick++;
        const active = loaderTick % steps.length;
        steps.forEach((s,i) => s.classList.toggle('active', i === active));
        const pseudo = Math.min(92, parseInt(bar.style.width||'0', 10) + 2);
        bar.style.width = pseudo + '%';
      }, 650);
    }

    function stopLoaderUI() {
      const bar = document.getElementById('loaderBar');
      if (loaderInterval) { clearInterval(loaderInterval); loaderInterval = null; }
      requestAnimationFrame(() => { bar.style.width = '100%'; });
    }
    async function handleUpload(file){
      startScreen.classList.remove("active");
      loader.classList.add("active");
      startLoaderUI(); // üê¢ start turtle + progress bar
    
      const formData = new FormData();
      formData.append("file", file);
    
      try{
        const res = await fetch("http://localhost:8000/upload", { method: "POST", body: formData });
        const data = await res.json();
        analysisData = data;
      }catch(e){
        alert("Upload failed: " + e.message + ". We'll continue with an empty UI so you can test the flow.");
        analysisData = {};
      }finally{
        stopLoaderUI(); // ‚úÖ finish turtle + bar
        loader.classList.remove("active");
        dashboard.classList.add("active");
        initDashboard();
      }
    }
    

    function initDashboard(){
      document.querySelectorAll(".menu-block").forEach(btn => {
        // Disable tap behavior ‚Äî only allow dragging
        btn.addEventListener("click", e => {
          e.preventDefault();
          alert("üß± Drag this block onto the stage to build!");
        });
      });      

      turtleOpenAll.addEventListener("click", () => {
        document.querySelectorAll(".section").forEach(s => s.classList.add("active"));
        openInsights(); 
      });      
      stageBox.addEventListener("click", () => {
        if (stageIndex >= BUILD_FRAMES.length - 1) turtleOpenAll.click();
      });

      displayResults(analysisData || {});
    }

    function addNextBlock(section){
      if (clickedSet.has(section)) { openSection(section); return; }
      clickedSet.add(section);

      stageEmpty.style.display = "none";

      const pos = orderedSections.indexOf(section);
      if (pos === -1) return;

      const targetIndex = Math.min(clickedSet.size - 1, BUILD_FRAMES.length - 1);
      if (targetIndex !== stageIndex){
        stageIndex = targetIndex;
        buildImg.classList.remove("show");
    
        const isFinal = (clickedSet.size === orderedSections.length);
        const nextSrc = isFinal ? "images/Final_Turtle.png" : BUILD_FRAMES[stageIndex];
    
        buildImg.onerror = () => {
          console.error("Image failed to load:", nextSrc);
          alert("Couldn't load image: " + nextSrc + "\n(Check file name/case and folder path)");
        };
    
        buildImg.onload = () => {
          buildImg.classList.add("show");
    
          if (isFinal) {
            stageBox.classList.add("whoosh");
            setTimeout(() => {
              stageBox.classList.remove("whoosh");
              stageBox.classList.add("pulse");
            }, 620);
            turtleOpenAll.style.display = "inline-block";
          }
        };
    
        setTimeout(() => {
          buildImg.src = nextSrc;
        }, 60);
      }
    }

    function openSection(id){
      closeSections();
      document.getElementById(id)?.classList.add("active");

      if (id === "terraform" && analysisData?.aws_infrastructure_diagram) {
        const target = document.getElementById("terraform-diagram");
        target.innerHTML = "";
        try {
          renderAWSInfrastructureDiagram(target, analysisData.aws_infrastructure_diagram);
        } catch {
          const summary = analysisData.aws_infrastructure_diagram.summary;
          if (summary?.service_types?.length){
            target.innerHTML = `
              <div style="padding: 20px;">
                <h3>AWS Infrastructure Recommendations</h3>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-top:12px;">
                  ${summary.service_types.map(s => `<div style="border:1px solid #e2e8f0;border-radius:10px;padding:12px;background:#fff">${s}</div>`).join("")}
                </div>
              </div>`;
          }
        }
      }
    }
    function closeSections(){ document.querySelectorAll(".section").forEach(s => s.classList.remove("active")); }
    document.querySelectorAll("[data-close]").forEach(x => x.addEventListener("click", closeSections));

    function displayResults(data){
      // Display project overview
      if (data.project_overview) {
        const overview = data.project_overview;
        const overviewHtml = overview.overview_text
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/‚Ä¢ (.*?)\n/g, '<li>$1</li>')
          .replace(/\n\n/g, '</p><p>')
          .replace(/^(.*)$/gm, '<p>$1</p>')
          .replace(/<p><\/p>/g, '')
          .replace(/<p>(<li>.*<\/li>)<\/p>/g, '<ul>$1</ul>');
        
        document.getElementById('overview-content').innerHTML = overviewHtml;
      } else {
        document.getElementById('overview-content').innerHTML = '<p>No project overview available.</p>';
      }
      
      const langs = data.languages || {};
      document.getElementById('languages').innerHTML = Object.entries(langs)
        .map(([lang,count]) => `<div class="item">${lang}: ${count} file(s)</div>`).join('') || '<div class="item">None</div>';

      const servicesWithRefs = data.services_with_references || {};
      const allServices = data.services || {};
      
      document.getElementById('services').innerHTML = Object.keys(allServices).length
        ? Object.entries(allServices).map(([serviceName, count])=>{
            const hasRefs = servicesWithRefs[serviceName]?.references?.length > 0;
            
            if (hasRefs) {
              return `<div class="item" style="cursor: pointer; color: #2F7D32; text-decoration: underline;" onclick="showServiceReferences('${serviceName.replace(/'/g, "\\'")}')">üìç ${serviceName}: ${count} ref(s)</div>`;
            } else {
              return `<div class="item">${serviceName}: ${count} ref(s)</div>`;
            }
          }).join('')
        : '<div class="item">No services detected</div>';

      window.servicesReferencesData = servicesWithRefs;

      const files = data.file_details || [];
      document.getElementById('file-details').innerHTML = files.map(f => {
        const ltags = (f.languages||[]).map(x=>`<span class="tag language">${x}</span>`).join('');
        const stags = (f.services||[]).map(x=>`<span class="tag service">${x}</span>`).join('');
        return `<div class="file-item"><div class="file-name">${f.file}</div><div class="file-tags">${ltags}${stags}</div></div>`;
      }).join('');

      if (data.workflow_diagram?.architecture?.components){
        const arch = data.workflow_diagram.architecture;
        const users = arch.components.filter(c=>c.type==='user');
        const apps  = arch.components.filter(c=>c.type==='application');
        const dbs   = arch.components.filter(c=>c.type==='database');
        const comp = c => `
          <div style="padding:14px;border:2px solid #e5e7eb;border-radius:12px;background:#fff;min-width:140px;text-align:center">
            ${c.logo ? `<img src="${c.logo}" alt="${c.title}" style="width:40px;height:40px;object-fit:contain">` : ''}
            <div style="font-weight:700;margin-top:8px">${c.title||''}</div>
            <div style="font-size:12px;color:#64748b">${c.description||''}</div>
          </div>`;
        document.getElementById('workflow-diagram').innerHTML = `
          <div style="text-align:center">
            <h4>Actors</h4>
            <div style="display:flex;gap:18px;flex-wrap:wrap;justify-content:center;margin:10px 0 20px">${users.map(comp).join('')}</div>
            <div style="font-size:26px;color:#3b82f6">‚Üì</div>
            <h4>Application Layer</h4>
            <div style="display:flex;gap:18px;flex-wrap:wrap;justify-content:center;margin:10px 0 20px">${apps.map(comp).join('')}</div>
            ${dbs.length ? `
              <div style="font-size:26px;color:#3b82f6">‚Üì</div>
              <h4>Data Storage</h4>
              <div style="display:flex;gap:18px;flex-wrap:wrap;justify-content:center;margin:10px 0 20px">${dbs.map(comp).join('')}</div>
            `:``}
          </div>`;
      }

      // Render layered architecture diagram if available
      if (data.layered_diagram) {
        const diagramContainer = document.getElementById('diagram');
        diagramContainer.innerHTML = '';
        renderLayeredFileArchitecture(diagramContainer, data.layered_diagram);
      } else if (data.comprehensive_diagram){
        document.getElementById('nodes').innerHTML =
          '<h4 style="margin:6px 0">Components</h4>' +
          data.comprehensive_diagram.nodes.map(n=>`<div class="item">${n.label} (${n.category})</div>`).join('');
        document.getElementById('connections').innerHTML =
          '<h4 style="margin:6px 0">Connections</h4>' +
          data.comprehensive_diagram.edges.map(e=>`<div class="item">${e.source} ‚Üí ${e.target}</div>`).join('');
      }

      document.getElementById('frontend-preview').innerHTML =
        data.frontend_preview || '<div style="text-align:center;padding:40px;color:#666"><h3>No Frontend Detected</h3><p>This looks like a backend/CLI project.</p></div>';

      document.getElementById('readme-content').textContent = data.readme_content || 'No README content generated';
      window.currentReadmeFilename = data.readme_filename;
    }

    function copyReadme(){
      const content = document.getElementById('readme-content').textContent;
      navigator.clipboard.writeText(content).then(()=>alert("README copied!"));
    }
    function downloadReadme(){
      if (!window.currentReadmeFilename) return;
      const a = document.createElement('a');
      a.href = `http://localhost:8000/download-readme/${window.currentReadmeFilename}`;
      a.download = 'README.md';
      a.click();
    }
    function toggleReadmePreview(){
      const content = document.getElementById('readme-content');
      const isRaw = content.style.whiteSpace === 'pre-wrap';
      if(isRaw){
        let html = content.textContent
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/^# (.*$)/gm, '<h1>$1</h1>')
          .replace(/^## (.*$)/gm, '<h2>$1</h2>')
          .replace(/^### (.*$)/gm, '<h3>$1</h3>')
          .replace(/^- (.*$)/gm, '<li>$1</li>')
          .replace(/`([^`]+)`/g, '<code>$1</code>')
          .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
        
        // Convert markdown tables to HTML
        html = html.replace(/(\|[^\n]+\|\n\|[:\-\s\|]+\|\n(?:\|[^\n]+\|\n?)*)/g, (match) => {
          const lines = match.trim().split('\n');
          const headers = lines[0].split('|').slice(1, -1).map(h => h.trim());
          const rows = lines.slice(2).map(row => row.split('|').slice(1, -1).map(cell => cell.trim()));
          
          return `<table style="border-collapse:collapse;width:100%;margin:10px 0">
            <thead><tr>${headers.map(h => `<th style="border:1px solid #ddd;padding:8px;background:#f5f5f5">${h}</th>`).join('')}</tr></thead>
            <tbody>${rows.map(row => `<tr>${row.map(cell => `<td style="border:1px solid #ddd;padding:8px">${cell}</td>`).join('')}</tr>`).join('')}</tbody>
          </table>`;
        });
        
        content.innerHTML = html.replace(/\n/g, '<br>');
        content.style.whiteSpace = 'normal';
      }else{
        content.textContent = analysisData?.readme_content || 'No README content';
        content.style.whiteSpace = 'pre-wrap';
      }
    }
    function openInsights(){
      populateInsights(analysisData || {});
      insightsBackdrop.classList.add('show');
      insightsModal.classList.add('show');
      document.body.style.overflow = 'hidden';
    }
    function closeInsights(){
      insightsBackdrop.classList.remove('show');
      insightsModal.classList.remove('show');
      document.body.style.overflow = '';
    }
    insightsBackdrop.addEventListener('click', closeInsights);
    insightsClose.addEventListener('click', closeInsights);
    window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeInsights(); });

    // Service References Popup
    const servicePopupBackdrop = document.getElementById('servicePopupBackdrop');
    const servicePopup = document.getElementById('servicePopup');
    const servicePopupClose = document.getElementById('servicePopupClose');
    const servicePopupTitle = document.getElementById('servicePopupTitle');
    const servicePopupBody = document.getElementById('servicePopupBody');

    function showServiceReferences(serviceName) {
      const serviceData = window.servicesReferencesData?.[serviceName];
      if (!serviceData || !serviceData.references?.length) {
        alert('No code references found for this service.');
        return;
      }

      servicePopupTitle.textContent = `${serviceName} - Code References`;
      
      const referencesHtml = serviceData.references.map(ref => {
        const highlightedCode = ref.code.replace(
          new RegExp(escapeRegex(ref.match), 'gi'),
          `<span class="reference-match">${ref.match}</span>`
        );
        
        return `
          <div class="reference-item">
            <div class="reference-file">${ref.file}</div>
            <div class="reference-line">Line ${ref.line}</div>
            <div class="reference-code">${highlightedCode}</div>
          </div>
        `;
      }).join('');
      
      servicePopupBody.innerHTML = referencesHtml;
      servicePopupBackdrop.style.display = 'block';
      servicePopup.style.display = 'block';
      document.body.style.overflow = 'hidden';
    }

    function closeServicePopup() {
      servicePopupBackdrop.style.display = 'none';
      servicePopup.style.display = 'none';
      document.body.style.overflow = '';
    }

    function escapeRegex(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    servicePopupBackdrop.addEventListener('click', closeServicePopup);
    servicePopupClose.addEventListener('click', closeServicePopup);
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeServicePopup();
        closeInsights();
      }
    });

    // Make showServiceReferences globally available
    window.showServiceReferences = showServiceReferences;

    // simple tabs
    tabButtons.forEach((btn, i) => {
      btn.addEventListener('click', () => {
        tabButtons.forEach(b => b.setAttribute('aria-selected','false'));
        tabPanels.forEach(p => p.classList.add('hide'));
        btn.setAttribute('aria-selected','true');
        tabPanels[i].classList.remove('hide');
      });
    });

    function pluralize(n, s){ return `${n} ${s}${n===1?'':'s'}`; }

    function populateInsights(data){
      const files = data.file_details || [];
      const langsObj = data.languages || {};
      const langNames = Object.keys(langsObj);
      const primaryLangs = langNames.slice(0,3).join(', ') || '‚Äî';

      // Overview KPIs
      document.getElementById('kpi-files').textContent = files.length ? pluralize(files.length, 'file') : '‚Äî';
      document.getElementById('kpi-langs').textContent = primaryLangs;
      document.getElementById('kpi-framework').textContent = (data.framework || 'React 18.x');
      document.getElementById('kpi-build').textContent = (data.build_tool || 'Vite');

      // Overview bullets (derive simple highlights)
      const overview = [
        primaryLangs !== '‚Äî' ? `Modern ${primaryLangs} project` : null,
        data?.comprehensive_diagram ? 'Component-based architecture detected' : null,
        (data?.aws_infrastructure_diagram ? 'IaC with Terraform present' : null),
        (data?.frontend_preview ? 'Frontend preview available' : null)
      ].filter(Boolean);
      const ob = document.getElementById('overview-bullets');
      ob.innerHTML = overview.length ? overview.map((t,i)=>`<div> ${i+1}. ${t}</div>`).join('') : '<div class="muter">No highlights detected.</div>';

      // Architecture
      document.getElementById('kpi-routing').textContent = data?.routing || 'React Router v6';
      document.getElementById('kpi-state').textContent   = data?.state || 'React Query + Local State';
      document.getElementById('kpi-styling').textContent = data?.styling || 'Tailwind CSS + CSS Modules';

      const archCards = document.getElementById('arch-cards');
      if (data?.workflow_diagram?.architecture?.components) {
        const comp = data.workflow_diagram.architecture.components;
        const apps = comp.filter(c=>c.type==='application').map(c=>c.title).filter(Boolean);
        archCards.innerHTML = `
          <h3 style="margin:0 0 8px">Detected Components</h3>
          <div>${apps.map(a=>`<span class="bubble">${a}</span>`).join('') || '<span class="muter">No application components detected.</span>'}</div>
        `;
      } else {
        archCards.innerHTML = `<div class="muter">No architecture graph available.</div>`;
      }

      // Infrastructure
      const infra = data?.aws_infrastructure_diagram?.summary || {};
      document.getElementById('kpi-provider').textContent = infra.provider || 'AWS';
      document.getElementById('kpi-version').textContent  = infra.version  || '1.5.x';
      document.getElementById('kpi-modules').textContent  = infra.modules  ? pluralize(infra.modules, 'module') : '‚Äî';
      document.getElementById('kpi-resources').textContent= infra.resources? pluralize(infra.resources,'resource') : '‚Äî';
      const ib = document.getElementById('infra-bullets');
      const services = infra.service_types || [];
      ib.innerHTML = services.length ? services.map((s,i)=>`<div>${i+1}. ${s}</div>`).join('') : '<div class="muter">No AWS services detected.</div>';

      // Components
      document.getElementById('kpi-ui').textContent     = data?.ui_components ? pluralize(data.ui_components, 'component') : '‚Äî';
      document.getElementById('kpi-custom').textContent = data?.custom_components ? pluralize(data.custom_components, 'component') : '‚Äî';
      document.getElementById('kpi-pages').textContent  = data?.pages ? pluralize(data.pages, 'page') : '‚Äî';
      document.getElementById('kpi-hooks').textContent  = data?.custom_hooks ? pluralize(data.custom_hooks, 'custom hook') : '‚Äî';
      const cb = document.getElementById('components-bullets');
      const compBullets = [
        data?.shadcn ? 'Shadcn/ui integration' : null,
        'Custom LegoBrick interactive component',
        'Animated header & responsive dialogs'
      ].filter(Boolean);
      cb.innerHTML = compBullets.map((t,i)=>`<div>${i+1}. ${t}</div>`).join('');

      // Frontend
      document.getElementById('kpi-fe-fw').textContent   = data?.frontend_framework || 'React 18.3.x';
      document.getElementById('kpi-ts').textContent      = data?.typescript_version || '5.x';
      document.getElementById('kpi-buildtime').textContent = data?.build_time || '~2.3s';
      document.getElementById('kpi-bundle').textContent  = data?.bundle_size || '~245KB (gzipped)';
      const fb = document.getElementById('frontend-bullets');
      const feBullets = ['Vite dev server','HMR','Code splitting','PWA ready'];
      fb.innerHTML = feBullets.map((t,i)=>`<div>${i+1}. ${t}</div>`).join('');

      // Docs
      document.getElementById('kpi-setup').textContent   = data?.setup_time || '< 5 minutes';
      document.getElementById('kpi-prereq').textContent  = data?.prerequisites || 'Node.js 18+';
      document.getElementById('kpi-scripts').textContent = data?.scripts_count ? `${data.scripts_count} scripts` : '4 scripts';
      document.getElementById('kpi-docs').textContent    = data?.docs_status || 'Complete';
      document.getElementById('docs-readme').textContent = (data?.readme_content || '').slice(0,1600) || 'No README content generated';
    }  
    
    function goHome() {
      // üßπ Step 1: Hide dashboard & loader
      document.getElementById("dashboard").classList.remove("active");
      document.getElementById("loader").classList.remove("active");
    
      // üß© Step 2: Reset LEGO build stage
      const buildImg = document.getElementById("buildImg");
      if (buildImg) {
        buildImg.src = "";
        buildImg.classList.remove("show");
      }
      const stageEmpty = document.getElementById("stageEmpty");
      if (stageEmpty) stageEmpty.style.display = "block";
    
      // üß± Step 3: Reset block-building state
      clickedSet = new Set();
      stageIndex = -1;
    
      // ü™Ñ Step 4: Hide insights, popups, and overlays
      document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
      document.getElementById("insightsBackdrop")?.classList.remove("show");
      document.getElementById("insightsModal")?.classList.remove("show");
      document.getElementById("servicePopup")?.style.setProperty("display", "none");
      document.getElementById("servicePopupBackdrop")?.style.setProperty("display", "none");
    
      // üê¢ Step 5: Hide the ‚ÄúOpen All‚Äù button
      const turtleOpenAll = document.getElementById("turtleOpenAll");
      if (turtleOpenAll) turtleOpenAll.style.display = "none";
    
      // üåø Step 6: Fade-in transition back to start screen
      const startScreen = document.getElementById("start-screen");
      startScreen.classList.add("active");
      startScreen.style.opacity = 0;
      requestAnimationFrame(() => {
        startScreen.style.transition = "opacity 0.6s ease";
        startScreen.style.opacity = 1;
      });
    
      // üåÄ Step 7: Reset scroll and body overflow
      window.scrollTo({ top: 0, behavior: "smooth" });
      document.body.style.overflow = "hidden";
    }
    
    // üéØ Connect button
    document.getElementById("homeBtn").addEventListener("click", goHome);
    
 let draggedSection = null;

 document.querySelectorAll('.lego-button.menu-block').forEach(btn => {
   btn.setAttribute('draggable', 'true');
   btn.addEventListener('dragstart', e => {
     draggedSection = btn.dataset.section;
     e.dataTransfer.effectAllowed = 'move';
     btn.classList.add('dragging');
   });
   btn.addEventListener('dragend', () => {
     btn.classList.remove('dragging');
     // ‚ö†Ô∏è Don't clear draggedSection here ‚Äî keep it for drop
   });
 });
 
 const stageBoxEl = document.getElementById('stageBox');
 stageBoxEl.addEventListener('dragover', e => {
   e.preventDefault();
   stageBoxEl.classList.add('highlight-drop');
 });
 stageBoxEl.addEventListener('dragleave', () => {
   stageBoxEl.classList.remove('highlight-drop');
 });
 stageBoxEl.addEventListener('drop', e => {
   e.preventDefault();
   stageBoxEl.classList.remove('highlight-drop');
 
   if (!draggedSection) return;
 
   // üß© Build animation immediately
   addNextBlock(draggedSection);
 
   // ü™ß Temporary ‚Äúbuilding‚Äù message
   const buildingText = document.createElement("div");
   buildingText.id = "buildingText";
   buildingText.textContent = "üß± Building...";
   Object.assign(buildingText.style, {
     position: "absolute",
     bottom: "12px",
     left: "50%",
     transform: "translateX(-50%)",
     fontWeight: "700",
     color: "#2F7D32",
     animation: "fadein 0.5s ease",
   });
   stageBoxEl.appendChild(buildingText);
 
   // ‚úÖ After 1.5s: remove text and open section immediately (no auto-close)
   setTimeout(() => {
     buildingText.remove();
     openSection(draggedSection);
     const sectionEl = document.getElementById(draggedSection);
     if (sectionEl) {
       sectionEl.classList.add("active");
       sectionEl.style.zIndex = "25";
       sectionEl.scrollTop = 0;
     }
   }, 1500);
 
   // now safe to clear
   setTimeout(() => { draggedSection = null; }, 2000);
 }); 
  </script>
</body>
</html>