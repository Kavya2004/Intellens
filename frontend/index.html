<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üß± Intellens Project Analyzer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:"Poppins",sans-serif}
    body{background:radial-gradient(circle at 25% 25%,#f0f3f9,#dfe6ee);min-height:100vh}

    /* screens */
    .screen{min-height:100vh;display:none;align-items:center;justify-content:center;padding:40px}
    .screen.active{display:flex}

    /* start */
    #start-screen{flex-direction:column;gap:24px}
    .title-xl{font-size:42px;font-weight:700;color:#232f3e;text-align:center}
    .subtitle{font-size:16px;color:#475569}
    .upload-box{border:3px dashed #a3aed0;border-radius:20px;padding:36px 28px;width:420px;background:#fff;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.06);transition:.25s;cursor:pointer}
    .upload-box:hover{border-color:#4ECDC4;transform:translateY(-2px) scale(1.02)}
    .btn{background:#ff9900;color:#fff;font-weight:700;border:none;border-radius:12px;padding:12px 18px;cursor:pointer}
    .hint{color:#64748b;font-size:12px;margin-top:6px}

    /* loading */
    #loading-screen{flex-direction:column;gap:18px}
    .lego-loader{display:flex;gap:10px;align-items:flex-end;justify-content:center;margin-top:10px}
    .lego{width:28px;height:28px;border-radius:6px;animation:bounce 1.4s infinite ease-in-out}
    .lego:nth-child(1){background:#4ECDC4;animation-delay:0s}
    .lego:nth-child(2){background:#FF6B35;animation-delay:.15s}
    .lego:nth-child(3){background:#FFD166;animation-delay:.3s}
    .lego:nth-child(4){background:#5B6DCD;animation-delay:.45s}
    @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}

    /* builder shell */
    #builder-screen{align-items:stretch;gap:20px}
    .shell{display:grid;grid-template-columns:260px 1fr;gap:20px;width:100%;max-width:1200px;min-height:80vh}
    .sidebar{background:linear-gradient(180deg,#232f3e,#39465a);color:#fff;border-radius:18px;padding:22px 16px;box-shadow:4px 0 8px rgba(0,0,0,.06);display:flex;flex-direction:column;gap:12px}
    .sidebar h2{font-size:18px;margin-bottom:4px}
    .lego-block-btn{display:flex;align-items:center;gap:10px;background:#ffb54d;color:#1f2937;border:none;border-radius:12px;padding:10px 12px;font-weight:700;cursor:pointer}
    .lego-icon{width:26px;height:16px;background-size:contain;background-repeat:no-repeat;background-position:center}

    .stage{background:repeating-linear-gradient(45deg,#f8fafc 0,#f8fafc 18px,#eef2f7 18px,#eef2f7 36px);border-radius:20px;padding:18px;box-shadow:inset 0 0 20px rgba(0,0,0,.04);display:grid;grid-template-columns:2fr 1fr;gap:16px}
    .build-area{background:#fff;border-radius:16px;padding:16px;position:relative;overflow:hidden;min-height:520px;border:2px dashed #e5e7eb;display:flex;align-items:center;justify-content:center}
    #buildImage{max-width:85%;max-height:85%;object-fit:contain;filter:drop-shadow(0 12px 24px rgba(0,0,0,.14))}
    .panel{background:#fff;border-radius:16px;padding:16px;overflow:auto;border:1px solid #e5e7eb}
    .panel h3{font-size:18px;margin-bottom:10px;color:#0f172a}
    .panel .empty{color:#6b7280;font-size:14px}

    /* whoosh -> turtle */
    .whoosh{animation:whoosh .7s cubic-bezier(.2,.8,.2,1) forwards}
    @keyframes whoosh{
      0%{transform:scale(1) rotate(0deg);opacity:1}
      40%{transform:scale(1.15) rotate(-3deg);opacity:.9;filter:blur(0)}
      60%{transform:scale(.85) rotate(2deg);opacity:.7;filter:blur(1px)}
      100%{transform:scale(1) rotate(0deg);opacity:1;filter:blur(0)}
    }

    /* modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:100}
    .modal.active{display:flex}
    .modal-card{width:min(1000px,92vw);max-height:86vh;overflow:auto;background:#fff;border-radius:16px;padding:20px;box-shadow:0 20px 60px rgba(0,0,0,.2);position:relative}
    .modal-close{position:absolute;top:10px;right:12px;font-size:22px;cursor:pointer;color:#ef4444}
    .divider{height:1px;background:#e5e7eb;margin:12px 0}
  </style>
</head>
<body>

  <!-- START -->
  <section id="start-screen" class="screen active">
    <div>
      <div class="title-xl">Start Building...</div>
      <p class="subtitle" style="text-align:center;margin-top:6px">Upload a project ZIP and assemble your LEGO turtle ‚Äî each block unlocks a feature.</p>
      <div class="upload-box" onclick="document.getElementById('fileInput').click()">
        <input id="fileInput" type="file" accept=".zip" style="position:absolute;left:-9999px" onchange="uploadZip()" />
        <p>üì¶ Click to upload your <strong>.zip</strong> project</p>
        <p class="hint">We‚Äôll detect languages, services, Terraform & architecture</p>
      </div>
      <div style="text-align:center"><button class="btn" onclick="document.getElementById('fileInput').click()">Choose ZIP</button></div>
    </div>
  </section>

  <!-- LOADING -->
  <section id="loading-screen" class="screen">
    <div style="text-align:center">
      <div class="title-xl" style="font-size:28px">Analyzing your project‚Ä¶</div>
      <div class="lego-loader" style="margin-top:10px">
        <div class="lego"></div><div class="lego"></div><div class="lego"></div><div class="lego"></div>
      </div>
      <div class="subtitle" style="margin-top:12px">Detecting languages, services, Terraform & architecture</div>
    </div>
  </section>

  <!-- BUILDER -->
  <section id="builder-screen" class="screen">
    <div class="shell">
      <aside class="sidebar">
        <h2>LEGO Blocks</h2>
        <!-- 8 blocks (fits your 6‚Äì8 requirement); order controls the build steps -->
        <button class="lego-block-btn" data-feature="summary"><span class="lego-icon" style="background-image:url('images/1-removebg-preview.png')"></span> üìä Summary</button>
        <button class="lego-block-btn" data-feature="architecture"><span class="lego-icon" style="background-image:url('images/2-removebg-preview.png')"></span> üèóÔ∏è Architecture</button>
        <button class="lego-block-btn" data-feature="terraform"><span class="lego-icon" style="background-image:url('images/3-removebg-preview.png')"></span> ‚òÅÔ∏è Terraform</button>
        <button class="lego-block-btn" data-feature="services"><span class="lego-icon" style="background-image:url('images/7-removebg-preview.png')"></span> üß© Services</button>
        <button class="lego-block-btn" data-feature="components"><span class="lego-icon" style="background-image:url('images/8-removebg-preview.png')"></span> üß± Components</button>
        <button class="lego-block-btn" data-feature="workflow"><span class="lego-icon" style="background-image:url('images/9-removebg-preview.png')"></span> üîÑ Workflow</button>
        <button class="lego-block-btn" data-feature="diagram"><span class="lego-icon" style="background-image:url('images/6-removebg-preview.png')"></span> üìê Diagram</button>
        <button class="lego-block-btn" data-feature="frontend"><span class="lego-icon" style="background-image:url('images/5-removebg-preview.png')"></span> üíª Frontend</button>

      </aside>

      <div class="stage">
        <div class="build-area">
          <img id="buildImage" alt="LEGO build stage" src="images/4-removebg-preview.png">
        </div>

        <div class="panel">
          <h3 id="panelTitle">Nothing selected</h3>
          <div id="panelBody">
            <p class="empty">Click a LEGO block on the left. Each click adds a piece to the turtle and opens its feature. After the last block, the turtle will assemble with a ‚ú®whoosh‚ú® ‚Äî click the turtle to see <em>All Info</em>.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- MODAL -->
  <div id="modal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="modal-close" onclick="closeModal()">‚úñ</div>
      <div id="modalContent"></div>
    </div>
  </div>

  <!-- Your renderers -->
  <script src="aws-infrastructure-designer.js"></script>
  <script src="aws-tech-diagram.js"></script>
  <script src="architecture-renderer.js"></script>
  <script src="layered-architecture-renderer.js"></script>
  <script src="diagram.js"></script>

  <script>
    // ---------- STATE ----------
    let analysisData = {};
    const used = new Set();

    // Build sequence images (center-stage). 8 steps + final whoosh to turtle.
    const STEP_IMAGES = [
  'images/8-removebg-preview.png',
  'images/7-removebg-preview.png',
  'images/6-removebg-preview.png',
  'images/5-removebg-preview.png',
  'images/4-removebg-preview.png',
  'images/3-removebg-preview.png',
  'images/2-removebg-preview.png',
  'images/1-removebg-preview.png'
];
const FINAL_TURTLE = 'images/AAGNLAg10so_1762583490149.png';
    let stepIndex = -1;

    const featureTitles = {
      summary:'Project Summary',
      architecture:'System Architecture',
      terraform:'Terraform Infrastructure',
      services:'Detected Services',
      components:'Component Diagram',
      workflow:'Processing Workflow',
      diagram:'Technology Diagram',
      frontend:'Frontend Preview'
    };

    // ---------- SCREENS ----------
    function show(id){
      document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    // ---------- UPLOAD ----------
    async function uploadZip(){
      const file = document.getElementById('fileInput').files[0];
      if(!file) return;
      show('loading-screen');

      const formData = new FormData();
      formData.append('file', file);

      try{
        const res = await fetch('http://127.0.0.1:8000/upload', {method:'POST', body:formData});
        if(!res.ok) throw new Error('Upload failed');
        analysisData = await res.json();

        // sane defaults
        analysisData.project_name ??= 'Your Project';
        analysisData.summary ??= {total_services:0, service_types:[], groups:{}};

        show('builder-screen');
      }catch(e){
        alert('Upload error: '+e.message);
        show('start-screen');
      }
    }

    // ---------- SIDE BAR CLICKS ----------
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.lego-block-btn');
      if(!btn) return;
      const feature = btn.dataset.feature;
      if(used.has(feature)) { openFeatureModal(feature); return; }

      used.add(feature);
      advanceBuild();          // update center image
      openFeaturePanel(feature);
    });

    function advanceBuild(){
      stepIndex += 1;
      const img = document.getElementById('buildImage');

      // last step ‚Üí whoosh + turtle
      if(stepIndex >= STEP_IMAGES.length){
        img.classList.remove('whoosh'); void img.offsetWidth; // restart animation
        img.classList.add('whoosh');
        setTimeout(()=>{
          img.src = FINAL_TURTLE;
          // clicking turtle opens All Info
          img.style.cursor = 'pointer';
          img.onclick = openAllInfo;
        }, 320);
        return;
      }

      img.classList.remove('whoosh'); void img.offsetWidth;
      img.classList.add('whoosh');
      img.src = STEP_IMAGES[stepIndex];
    }

    // ---------- RIGHT PANEL ----------
    function openFeaturePanel(feature){
      document.getElementById('panelTitle').textContent = featureTitles[feature] || 'Details';
      const body = document.getElementById('panelBody');
      body.innerHTML = `
        <div><strong>${featureTitles[feature] || 'Details'}</strong></div>
        <div class="divider"></div>
        <p style="color:#475569;font-size:14px">Open full view for interactive diagrams and rich details.</p>
        <div style="margin-top:10px"><button class="btn" onclick="openFeatureModal('${feature}')">Open Full View</button></div>
      `;
    }

    // ---------- MODAL CONTENT ----------
    function openModal(html){
      document.getElementById('modalContent').innerHTML = html;
      document.getElementById('modal').classList.add('active');
    }
    function closeModal(){ document.getElementById('modal').classList.remove('active'); }

    function openFeatureModal(feature){
      const title = featureTitles[feature] || 'Details';
      const id = 'featureHost_'+feature;
      openModal(`<h3 style="margin-bottom:8px">${title}</h3><div id="${id}" style="margin-top:10px"></div>`);
      const host = document.getElementById(id);

      switch(feature){
        case 'terraform':
          if(analysisData.aws_infrastructure_diagram) renderAWSInfra(host, analysisData.aws_infrastructure_diagram);
          else host.innerHTML = '<p>No Terraform diagram available.</p>';
          break;
        case 'architecture':
          if(analysisData.layered_architecture) renderLayeredArchitecture(host, analysisData.layered_architecture);
          else if(analysisData.architecture_diagram){ const el = renderArchitectureDiagram(analysisData.architecture_diagram); host.appendChild(el);}
          else host.innerHTML = '<p>No architecture data detected.</p>';
          break;
        case 'diagram':
        case 'services':
        case 'components':
          if(window.renderAwsTechDiagram && analysisData.tech_diagram){
            const el = renderAwsTechDiagram(analysisData.tech_diagram);
            host.appendChild(el);
          } else host.innerHTML = '<p>No technology/services diagram.</p>';
          break;
        case 'workflow':
          host.innerHTML = renderWorkflowHtml(analysisData.workflow || {});
          break;
        case 'frontend':
          host.innerHTML = (analysisData.frontend_preview_html ?? '<p>No frontend preview available.</p>');
          break;
        case 'summary':
        default:
          host.innerHTML = renderSummaryHtml();
      }
    }

    // ---------- ALL INFO (on turtle click) ----------
    function openAllInfo(){
      const id = 'allInfo';
      openModal(`<h3 style="margin-bottom:8px">üê¢ LEGO Turtle ‚Äî All Info</h3><div class="divider"></div><div id="${id}"></div>`);
      const host = document.getElementById(id);
      host.innerHTML = `
        <div style="display:grid;gap:12px">
          <div>${renderSummaryHtml()}</div>
          <div class="divider"></div>
          <div id="arch"></div>
          <div id="tf"></div>
          <div id="tech"></div>
        </div>
      `;
      // Architecture
      const arch = document.getElementById('arch');
      arch.innerHTML = '<h4 style="margin:6px 0">Architecture</h4>';
      if(analysisData.layered_architecture) renderLayeredArchitecture(arch, analysisData.layered_architecture);
      else if(analysisData.architecture_diagram){ const el = renderArchitectureDiagram(analysisData.architecture_diagram); arch.appendChild(el); }
      else arch.innerHTML += '<p>No architecture diagram.</p>';

      // Terraform
      const tf = document.getElementById('tf');
      tf.innerHTML = '<h4 style="margin:6px 0">Terraform Infrastructure</h4>';
      if(analysisData.aws_infrastructure_diagram) renderAWSInfra(tf, analysisData.aws_infrastructure_diagram);
      else tf.innerHTML += '<p>No Terraform details found.</p>';

      // Tech / Services
      const tech = document.getElementById('tech');
      tech.innerHTML = '<h4 style="margin:6px 0">Technology & Services</h4>';
      if(window.renderAwsTechDiagram && analysisData.tech_diagram){
        const el = renderAwsTechDiagram(analysisData.tech_diagram);
        tech.appendChild(el);
      } else tech.innerHTML += '<p>No technology diagram.</p>';
    }

    // ---------- Small render helpers ----------
    function renderSummaryHtml(){
      const s = analysisData.summary || {total_services:0, service_types:[], groups:{}};
      const langs = analysisData.languages_detected || [];
      return `
        <div>
          <strong>Project:</strong> ${analysisData.project_name || 'Your Project'}<br/>
          <strong>Languages:</strong> ${langs.join(', ') || '‚Äî'}<br/>
          <strong>Detected Services:</strong> ${(s.service_types||[]).join(', ') || '‚Äî'}<br/>
          <strong>Total Services:</strong> ${s.total_services ?? 0}
        </div>`;
    }
    function renderWorkflowHtml(data){
      const steps = (data.steps||[]).map((st,i)=>`
        <div style="display:flex;gap:8px;align-items:center;margin:6px 0">
          <div style="width:26px;height:26px;border-radius:50%;background:#232f3e;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700">${i+1}</div>
          <div><strong>${st.title||'Step'}</strong><div style="font-size:12px;color:#64748b">${st.description||''}</div></div>
        </div>`).join('');
      return steps || '<p>No workflow available.</p>';
    }
    function renderAWSInfra(host, data){
      const holder = document.createElement('div');
      host.appendChild(holder);
      try{ new AWSInfrastructureDesigner(holder, data); }
      catch(e){ holder.innerHTML='<p>Could not render AWS Infrastructure diagram.</p>'; console.error(e); }
    }
  </script>
</body>
</html>
